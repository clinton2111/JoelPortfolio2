angular.module("joelDashBoard",["ui.router","angular-jwt","angular-storage","joelDashBoard.login","joelDashBoard.DashCtrl","ngFileUpload","angular-md5"]).config(["$stateProvider","$urlRouterProvider","$httpProvider","jwtInterceptorProvider",function(e,t,n,r){return e.state("auth",{url:"/auth/:type/:email/:value",templateUrl:"partials/auth.html",controller:"loginController"}).state("dashboard",{url:"/dashboard","abstract":!0,templateUrl:"partials/dashboard.html",controller:"dashboardController",data:{requiresLogin:!0}}).state("dashboard.home",{url:"",templateUrl:"partials/home.html",data:{requiresLogin:!0}}).state("dashboard.photos",{url:"/photos",templateUrl:"partials/photos.html",data:{requiresLogin:!0}}).state("dashboard.gigs",{url:"/gigs",templateUrl:"partials/gigs.html",data:{requiresLogin:!0}}).state("dashboard.account",{url:"/account",templateUrl:"partials/account.html",data:{requiresLogin:!0}}),t.when("dashboard","dashboard.photos"),t.otherwise("/auth/login//"),r.tokenGetter=["config","store",function(e,t){var n;if(e.url.substr(e.url.length-5)===".html")return null;n=t.get("user");if(!_.isNull(n.token)||!_.isUndefined(n.token))return e.headers.Authorization=n.token}],n.interceptors.push("jwtInterceptor")}]).run(["$rootScope","$state","store","jwtHelper","$http","API","$q",function(e,t,n,r,i,s,o){return e.$on("$stateChangeStart",function(e,u){var a,f,l,c;f=function(){var e;return e=o.defer(),i.post(s.url+"refreshToken.php",null).then(function(t){return e.resolve(t.data)},function(t){return console.log("Error"),e.reject(data)}),e.promise},c=n.get("user");if(u.data&&u.data.requiresLogin){if(_.isNull(c)||_.isUndefined(c)||r.isTokenExpired(c.token))return e.preventDefault(),t.go("auth",{type:"login",email:null,value:null});a=moment(c.lastUpdate,"DD-MM-YYYY"),l=moment().isSame(moment(a),"day");if(!l)return f().then(function(r){var i,s;return i=r,!_.isNull(i.token)||!_.isUndefined(i.token)?(s={id:i.id,token:i.token,username:i.username,lastUpdate:moment().format("DD-MM-YYYY")},n.set("user",s)):(e.preventDefault(),t.go("auth",{type:"login",email:null,value:null}))},function(t){return e.preventDefault()})}})}]).constant("API",{url:"../api/source/"});